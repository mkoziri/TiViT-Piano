# Training hyperparameters and metrics for a single run.
training:
  epochs: 4
  learning_rate: 3e-5
  weight_decay: 0.01
  eval_freq: 1
  debug_dummy_labels: false
  log_interval: 25
  save_every: 1
  amp: false
  resume: false
  reset_head_bias: true

  soft_targets:
    enabled: false
    apply_to:
      onset: true
      pitch: true
      offset: false
    onset_kernel: [0.5, 1.0, 0.5]
    frame_kernel: [0.5, 1.0, 0.5]

  metrics:
    prob_threshold: 0.2
    prob_threshold_onset: 0.2
    prob_threshold_offset: 0.2
    prob_temperature: 1.0
    prob_temperature_onset: 1.0
    prob_temperature_offset: 1.0
    prob_logit_bias: 0.0
    prob_logit_bias_onset: 0.0
    prob_logit_bias_offset: 0.0
    decoder:
      onset:
        open: 0.01
        hold: 0.0075
        min_on: 2
        merge_gap: 1
      offset:
        open: 0.015
        hold: 0.01
        min_off: 2
        merge_gap: 1
    temporal_decoder:
      shared:
        low_ratio: 0.6
        min_on: 2
        min_off: 2
        gap_merge: 1
        median: 3
    aggregation:
      mode: k_of_p
      k:
        onset: 1
        offset: 1
      top_k: 3
      tau_sum: 0.0
    sweep:
      floor_band: [0.2, 0.3, 0.4]
      threshold_mode: quantile
      quantile_values: [0, 50, 70, 80, 90, 95, 98, 99]
      include_max_quantile: true

  best_selection:
    mode: calibrated_event
    trigger: on_proxy_improvement
    n: 1
    write_back: false
    sweep:
      delta: 0.05
      low_guard: 0.1
    min_prob: 0.02
    max_prob: 0.98

  # Single-source-of-truth loss config (no overrides anywhere else)
  loss:
    head_weights:
      pitch: 1.2
      onset: 1.8
      offset: 0.6
      hand: 0.3
      clef: 0.3

    # Used only if some head chooses pos_weight_mode: ema
    ema_alpha: 0.05

    # Applied only to onset/offset rolls
    neg_smooth_onoff: 0.0

    per_tile:
      enabled: true
      heads: [pitch, onset, offset]
      mask_cushion_keys: null
      debug:
        enabled: true
        interval: 200

    # Explicit per-head settings: no defaults, no inheritance, no alias keys
    heads:
      pitch:
        loss: bce_pos
        # pitch-only mode to preserve current behavior (code must support this explicitly)
        pos_weight_mode: "off"        # sqrt | adaptive_band | fixed | off
        pos_weight: null              # used only for fixed
        pos_weight_band: [2.0, 4.0]   # used only for adaptive_band

      onset:
        loss: focal                   # focal | bce_pos | bce | bce_with_logits
        # Focal ignores pos_weight; keep it explicit to avoid ambiguity
        pos_weight_mode: "off"
        pos_weight: null
        pos_weight_band: null
        focal_gamma: 4.0
        focal_alpha: 0.25
        prior_mean: 0.012
        prior_weight: 0.15

      offset:
        loss: focal
        pos_weight_mode: "off"
        pos_weight: null
        pos_weight_band: null
        focal_gamma: 2.5
        focal_alpha: 0.2
        prior_mean: 0.01
        prior_weight: 0.15

      hand:
        loss: ce

      clef:
        loss: ce

optim:
  grad_clip: 1.0
  head_lr_multiplier: 10.0
  offset_weight_decay_multiplier: 4.0

train:
  accumulate_steps: 12
  freeze_backbone_epochs: 0
