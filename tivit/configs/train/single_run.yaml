# Training hyperparameters and metrics for a single run.
training:
  epochs: 5
  learning_rate: 3e-5
  weight_decay: 0.01
  eval_freq: 1
  debug_dummy_labels: false
  log_interval: 1 # was 25
  save_every: 1
  amp: false
  resume: false
  reset_head_bias: true

  soft_targets:
    enabled: true
    apply_to:
      onset: true
      pitch: true
      offset: false
    onset_kernel: [0.5, 1.0, 0.5]
    frame_kernel: [0.5, 1.0, 0.5]

  metrics:
    prob_threshold: 0.006
    prob_threshold_onset: 0.006
    prob_threshold_offset: 0.007
    prob_temperature: 1.0
    prob_temperature_onset: 1.0
    prob_temperature_offset: 1.0
    prob_logit_bias: 0.0
    prob_logit_bias_onset: 0.0
    prob_logit_bias_offset: 0.0
    eval_mode: both
    patk:
      fps: 30.0
      onset_tolerance_ms: 100.0
      onset_sigma: 0.2
      onset_radius: 8
      frame_sigma: 0.8
      frame_radius: 4
      threshold: 0.0075
      ignore_tail: 4
      offset_ratio: 0.2
      offset_min_tolerance: 0.05
    decoder:
      onset:
        open: 0.006
        hold: 0.0036
        min_on: 1
        min_off: 1
        merge_gap: 0
        median: 1
      offset:
        open: 0.007
        hold: 0.0042
        min_off: 1
        merge_gap: 0
        median: 1
    temporal_decoder:
      shared:
        low_ratio: 0.6
        min_on: 2
        min_off: 2
        gap_merge: 1
        median: 3
    aggregation:
      mode: k_of_p
      k:
        onset: 1
        offset: 1
      top_k: 7
      tau_sum: 0.0
    sweep:
      floor_band: [0.2, 0.3, 0.4]
      threshold_mode: quantile
      quantile_values: [0, 50, 70, 80, 90, 95, 98, 99]
      include_max_quantile: true

  best_selection:
    mode: calibrated_event
    trigger: on_proxy_improvement
    n: 1
    write_back: false
    sweep:
      delta: 0.05
      low_guard: 0.1
    min_prob: 0.02
    max_prob: 0.98

  # Single-source-of-truth loss config (no overrides anywhere else)
  loss:
    pos_weight_path: tivit/logs/pos_weights.json
    head_weights:
      pitch: 1.0
      onset: 1.0
      offset: 1.0
      hand: 0.0
      clef: 0.0

    # Used only if some head chooses pos_weight_mode: ema
    ema_alpha: 0.05

    # Applied only to onset/offset rolls
    neg_smooth_onoff: 0.0

    per_tile:
      enabled: false
      heads: [pitch, onset, offset]
      mask_cushion_keys: null
      debug:
        enabled: false
        interval: 200

    # Explicit per-head settings: no defaults, no inheritance, no alias keys
    heads:
      pitch:
        loss: bce
        pos_weight_mode: "adaptive_band"        # sqrt | adaptive_band | fixed | off
        pos_weight: null              # used only for fixed
        pos_weight_band: [2.0, 4.0]   # used only for adaptive_band

      onset:
        loss: bce                   # focal | bce_pos | bce | bce_with_logits
        pos_weight_mode: "fixed"
        pos_weight: 20.0
        pos_weight_band: null
        focal_gamma: 2.0
        focal_alpha: 0.25
        prior_mean: 0.006626
        prior_weight: 0.0

      offset:
        loss: bce
        pos_weight_mode: "fixed"
        pos_weight: 15.0
        pos_weight_band: null
        focal_gamma: 2.5
        focal_alpha: 0.2
        prior_mean: 0.00608
        prior_weight: 0.0

      hand:
        loss: ce

      clef:
        loss: ce

optim:
  grad_clip: 1.0
  head_lr_multiplier: 1.0
  offset_weight_decay_multiplier: 1.0

train:
  accumulate_steps: 1
  freeze_backbone_epochs: 0
