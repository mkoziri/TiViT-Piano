experiment:
  name: "TiViT-Piano_OMAPS_calib"
  seed: 42
  output_dir: "outputs"

data:
  dataset: "OMAPS"
  root_dir: "./data_calib"
  annotations_root: "./data_calib"
  label_format: "txt"
  max_clips: null
  split_dir: splits
  split_train: "train"
  split_val: "train"
  split_test: "test"
  fps: 30
  tiles: [left, center, right]
  frames: 96
  frame_stride: 2
  resize: [224, 224]
  crop: [192, 192]
  grayscale: true
  sampler: { pre_roll: 24 }

loader:
  batch_size: 2
  num_workers: 4
  pin_memory: false
  persistent_workers: true

model:
  name: TiViTPiano
  # either give a preset name you have:
  backbone: vivit_tiny
  # or specify dims explicitly if you don't use presets:
  embed_dim: 192
  depth: 8
  num_heads: 3
  mlp_ratio: 3.0
  factorized_attn: true
  tubelet: [4, 32, 32]
  drop_path: 0.1
  dropout: 0.1
  attn_dropout: 0.0
  cls_heads:
    pitch:  { classes: 88, activation: sigmoid }
    onset:  { classes: 88, activation: sigmoid }
    offset: { classes: 88, activation: sigmoid }
    hand:   { classes: 2,  activation: softmax }
    clef:   { classes: 2,  activation: softmax }

loss:
  pitch:  { type: bce,       weight: 0.5, pos_weight: 6.0 }
  onset:  { type: focal_bce, weight: 1.0, alpha: 0.25, gamma: 1.5, pos_weight: 20.0 }
  offset: { type: focal_bce, weight: 1.0, alpha: 0.25, gamma: 1.5, pos_weight: 20.0 }
  hand:   { type: ce,        weight: 0.2, label_smoothing: 0.05 }
  clef:   { type: ce,        weight: 0.2, label_smoothing: 0.05 }

train:
  accumulate_steps: 4
  freeze_backbone_epochs: 3

optim:
  name: adamw
  base_lr: 3.0e-4
  head_lr: 1.2e-3
  weight_decay: 0.05
  betas: [0.9, 0.999]
  eps: 1.0e-8
  grad_clip: 1.0
  amp: false

sched:
  name: cosine
  warmup_epochs: 2
  epochs: 25
  min_lr_scale: 0.1

log:
  interval: 20
  save_dir: checkpoints
  save_best: true
  tensorboard: true

infer:
  pitch_thr: 0.20
  onset_thr: 0.06
  offset_thr: 0.04
  hysteresis:
    onset_open: 0.07
    onset_close: 0.04
    offset_open: 0.05
    offset_close: 0.03

eval:
  metrics: [f1_onset, f1_offset, pitch_acc, hand_acc, clef_acc]

runtime:
  torch_num_threads: 8
  deterministic: true

