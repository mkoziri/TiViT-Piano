experiment:
  name: TiViT-Piano_PianoVAM_cache
  seed: 1332
  deterministic: true
  output_dir: outputs

dataset:
  name: PianoVAM
  # If null, the dataset root is resolved as: $TIVIT_DATA_DIR/PianoVAM_v1.0
  root_dir: null
  annotations_root: null
  label_format: midi
  label_targets:
    - pitch
    - onset
    - offset
    - hand
    - clef
  max_clips: 5  #just for quick testing
  manifest:
    train: null
    val: null
    test: null
  split: train
  split_train: train
  split_val: val
  split_test: test
  frames: 96
  decode_fps: 30.0
  hop_seconds: 0.03333333333333333
  resize:
    - 180     # was 145
    - 1536    # was 1024
  tiles: 3
  channels: 3
  normalize: true
  apply_crop: true
  canonical_hw:
    - 180     # was 145
    - 1536    # was 1024
  registration:
    source: metadata
    interp: bilinear
    global_aug:
      enabled: false
      resize_jitter:
        - 185        # was 150
        - 1540       # was 1030
      random_crop_hw:
        - 180     # was 145
        - 1536    # was 1024
  crop_rescale: auto
  include_low_res: false
  batch_size: 2
  num_workers: 2
  prefetch_factor: 1
  shuffle: true

  sampler:
    mode: onset_balanced
    onset_frac: 0.5
    nearmiss_frac: 0.25
    bg_frac: 0.25
    nearmiss_radius: 6

  require_labels: true

  frame_targets:
    enable: true
    tolerance: 0.03
    dilate_active_frames: 1
    fill_mode: overlap
    hand_from_pitch: true
    clef_thresholds:
      - 60
      - 64
    note_min: 21
    note_max: 108
    cache_labels: true
    cache_dir: .cache/labels
    targets_sparse: true
  hand_supervision:
    enable: true          # default off for backward compatibility
    min_confidence: 0.05
    time_tolerance: 0.05
    max_dx: 0.12
    min_points: 4
    reach:
      enable: true
      radius: 0.12
      dilate_margin: 0.02
      min_points: 4

model:
  name: TiViT-Piano
  backend: vivit         # Allowed: "vivit" (default) or "vits_tile"
  head_mode: frame
  tiles: 3
  input_channels: 3
  transformer:
    type: ViViT
    input_patch_size: 16
    tube_size: 2
    d_model: 192
    num_heads: 3
    depth_temporal: 1
    depth_spatial: 1
    depth_global: 1
    global_tokens: 2
    mlp_ratio: 3.0
    dropout: 0.2
  vits_tile:
    backbone_name: vit_small_patch16_224  # or deit_small_patch16_224
    pretrained: true
    freeze_backbone: true
    input_hw:
      - 224
      - 224
    temporal_layers: 2
    temporal_heads: 4
    global_mixing_layers: 1
    embed_dim: 384
    dropout: 0.1

tiling:
  patch_w: 16
  tokens_split: auto
  overlap_tokens: 0

training:
  epochs: 4
  learning_rate: 3e-5
  weight_decay: 0.01
  eval_freq: 1
  debug_dummy_labels: false
  log_interval: 25
  save_every: 1
  amp: false
  resume: false
  reset_head_bias: true
  bias_seed:
    onoff_prior_mean: 0.012
  soft_targets:
    enabled: false
    apply_to:
      onset: true
      pitch: true
      offset: false
    onset_kernel:
    - 0.5
    - 1.0
    - 0.5
    frame_kernel:
    - 0.5
    - 1.0
    - 0.5
  loss:
    head_weights:
      onset: 1.8
      offset: 0.6
      pitch: 1.2
      hand: 0.3
      clef: 0.3
    ema_alpha: 0.05
    neg_smooth_onoff: 0.0
    per_tile:
      enabled: true
      heads:
        - pitch
        - onset
        - offset
      mask_cushion_keys: null
      debug:
        enabled: true
        interval: 200
    heads:
      pitch:
        loss: bce
        pos_weight_mode: sqrt
        pos_weight: null
        pos_weight_band:
          - 2.0
          - 4.0
      onset:
        loss: focal
        pos_weight_mode: adaptive
        pos_weight: null
        pos_weight_band:
          - 3.0
          - 5.0
        focal_gamma: 4.0
        focal_alpha: 0.25
        prior_mean: 0.012
        prior_weight: 0.15
      offset:
        loss: focal
        pos_weight_mode: adaptive
        pos_weight: null
        pos_weight_band:
          - 3.0
          - 5.0
        focal_gamma: 2.5
        focal_alpha: 0.2
        prior_mean: 0.01
        prior_weight: 0.15
      hand:
        loss: ce
      clef:
        loss: ce
  hand_gating:
    mode: loss_reweight            # off | loss_reweight
    strength: 0.75 # 1.0
  metrics:
    prob_threshold: 0.2
    prob_threshold_onset: 0.2
    prob_threshold_offset: 0.2
    prob_temperature: 1.0
    prob_temperature_onset: 1.0
    prob_temperature_offset: 1.0
    prob_logit_bias: 0.0
    prob_logit_bias_onset: 0.0
    prob_logit_bias_offset: 0.0
    decoder:
      onset:
        open: 0.01
        hold: 0.0075
        min_on: 2
        merge_gap: 1
      offset:
        open: 0.015
        hold: 0.01
        min_off: 2
        merge_gap: 1
    temporal_decoder:
      shared:
        low_ratio: 0.6
        min_on: 2
        min_off: 2
        gap_merge: 1
        median: 3
    aggregation:
      mode: k_of_p
      k:
        onset: 1
        offset: 1
      top_k: 3
      tau_sum: 0.0
    sweep:
      floor_band:
        - 0.20
        - 0.30
        - 0.40
      threshold_mode: quantile
      quantile_values:
        - 0
        - 50
        - 70
        - 80
        - 90
        - 95
        - 98
        - 99
      include_max_quantile: true
  best_selection:
    mode: calibrated_event
    trigger: on_proxy_improvement
    n: 1
    write_back: false
    frames: 96
    max_clips: 80
    split: val
    sweep:
      delta: 0.05
      low_guard: 0.1
    min_prob: 0.02
    max_prob: 0.98

optim:
  grad_clip: 1.0
  head_lr_multiplier: 10.0      # was 5.0
  offset_weight_decay_multiplier: 4.0

train:
  accumulate_steps: 12
  freeze_backbone_epochs: 0

decoder:
  global_fusion:
    enabled: false
    mode: masked_mean
    cushion_keys: 2
    apply_to:
      - onset
      - offset
      - pitch
    weighting: uniform
    consistency_check:
      enabled: false
      batches: 2
  post:
    snap:
      enabled: false
      bpm_min: 40
      bpm_max: 240
      bpm_step: 1
      local_window_beats: 4
      max_dev_ms: 35
      blend: 0.5
      min_support_notes: 12
      confidence_floor: 0.15
    dp:
      enabled: false
      min_on_beats: 0.25
      min_off_beats: 0.25
      penalty_on: 0.5
      penalty_off: 0.5
      keep_gates: false
      per_key: true
      beam: 5
      emission_mode: logit
      emission_gain: 4.0
      emission_bias: 0.0
    key_prior:
      enabled: true      # indentation fixed compared to the original YAML
      ref_head: onset
      apply_to:
        - onset
        - offset
      window_sec: 3.0
      beta: 4.0
      rho_uniform: 0.8
      prior_strength: 0.5
      epsilon: 1.0e-08
      fps: null
      midi_low: 21
      midi_high: null

logging:
  log_dir: logs
  checkpoint_dir: checkpoints
  tensorboard: true
  postproc_debug: true

autopilot:
  best_selection:
    owner: autopilot
  fast_strategy: two_stage
  onset_optimizer:
    open_grid:
      - 0.01
      - 0.015
      - 0.02
      - 0.03
    min_on_grid:
      - 2
      - 3
    hold_mode: fixed_ratio
    hold_delta: 0.06
    hold_min: 0.003
    hold_ratio: 0.75
    merge_gap: 1
    thr_anchor: 0.2
    thr_add_delta: 0.01
    thr_add_steps: 5
    thr_mul_ratio: 1.1
    thr_mul_orders: 1
    thr_min_prob: 0.005
    thr_max_prob: 0.98
    thr_low_guard: 0.01
    thr_high_guard: 0.6
    thr_min_points: 5
    thr_max_points: 11
  offset_optimizer:
    thr_anchor: 0.3
    thr_add_delta: 0.01
    thr_add_steps: 5
    thr_mul_ratio: 1.1
    thr_mul_orders: 1
    thr_min_prob: 0.02
    thr_max_prob: 0.98
    thr_low_guard: 0.02
    thr_high_guard: 0.95
    thr_min_points: 5
    thr_max_points: 11

inference:
  output_dir: inference_results
  predict_on_train: false
