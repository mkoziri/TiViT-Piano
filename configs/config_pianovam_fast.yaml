experiment:
  name: TiViT-Piano-PianoVAMv1-f128
  seed: 1332
  deterministic: true
  output_dir: outputs

dataset:
  name: PianoVAM
  root_dir: null                  # uses $TIVIT_DATA_DIR/PianoVAM_v1.0
  annotations_root: null
  label_format: tsv
  label_targets:
    - pitch
    - onset
    - offset
  max_clips: 80
  manifest:
    train: null
    val: null
    test: null
  split: train
  split_train: train
  split_val: valid
  split_test: test
  frames: 256
  decode_fps: 30.0                # used mainly for metrics/time conversion
  hop_seconds: 0.03333333333333333
  resize:
    - 145
    - 1024
  tiles: 3
  channels: 3
  normalize: true
  apply_crop: false
  canonical_hw:
    - 145
    - 1024
  registration:
    source: none
    interp: bilinear
    global_aug:
      enabled: false
      resize_jitter:
        - 150
        - 1030
      random_crop_hw:
        - 145
        - 1024
  crop_margin: 20
  crop_rescale: auto
  include_low_res: false
  batch_size: 2
  num_workers: 2
  prefetch_factor: 1
  shuffle: true

  # Sampler can be enabled now that we have labels (for future work),
  # but for the first supervised run we keep it off for simplicity.
  sampler:
    mode: null
    onset_frac: 0.5
    nearmiss_frac: 0.25
    bg_frac: 0.25
    nearmiss_radius: 6

  # The dataset now returns labels directly (pitch/onset/offset),
  # so we consider labels as required.
  require_labels: true

  # We do NOT use the generic frame_targets machinery yet, because
  # we are building frame-level labels directly in the dataset.
  frame_targets:
    enable: false
    tolerance: 0.03
    dilate_active_frames: 1
    fill_mode: overlap
    hand_from_pitch: true
    clef_thresholds:
      - 60
      - 64
    note_min: 21
    note_max: 108
    cache_labels: false
    cache_dir: .cache/labels
    targets_sparse: true

model:
  name: TiViT-Piano
  backend: vits_tile
  head_mode: frame
  tiles: 3
  input_channels: 3
  transformer:
    type: ViViT
    input_patch_size: 16
    tube_size: 2
    d_model: 192
    num_heads: 3
    depth_temporal: 1
    depth_spatial: 1
    depth_global: 1
    global_tokens: 2
    mlp_ratio: 3.0
    dropout: 0.2
  vits_tile:
    backbone_name: vit_small_patch16_224
    pretrained: true
    freeze_backbone: false
    input_hw:
      - 224
      - 224
    temporal_layers: 2
    temporal_heads: 4
    global_mixing_layers: 1
    embed_dim: 384
    dropout: 0.1

tiling:
  patch_w: 16
  tokens_split: auto
  overlap_tokens: 0

training:
  epochs: 50
  learning_rate: 1e-5
  weight_decay: 0.01
  eval_freq: 1
  debug_dummy_labels: false       
  log_interval: 25
  save_every: 1
  amp: false
  resume: false
  reset_head_bias: false
  bias_seed:
    onoff_prior_mean: 0.012
  loss_weights:
    onoff_loss: bce_pos
    onoff_pos_weight_mode: adaptive
    onoff_pos_weight: 8.0
    onoff_pos_weight_ema_alpha: 0.05
    onoff_neg_smooth: 0.0
    focal_gamma: 4.0
    focal_alpha: 0.25
    onoff_prior_mean: 0.012
    onoff_prior_weight: 0.3
    onoff_heads:
      onset:
        loss: focal
        pos_weight_mode: adaptive
        focal_gamma: 4.0
        focal_alpha: 0.25
        prior_mean: 0.012
        prior_weight: 0.3
      offset:
        loss: focal
        focal_gamma: 2.5
        focal_alpha: 0.2
        prior_mean: 0.01
        prior_weight: 0.3
    onset: 3.0
    offset: 1.5
    pitch: 0.5
    hand: 0.0         # we do not train hand/clef in this first run
    clef: 0.0
  metrics:
    prob_threshold: 0.2
    prob_threshold_onset: 0.05
    prob_threshold_offset: 0.2
    prob_temperature: 1.0
    prob_temperature_onset: 1.0
    prob_temperature_offset: 1.0
    prob_logit_bias: 0.0
    prob_logit_bias_onset: 0.0
    prob_logit_bias_offset: 0.0
    decoder:
      onset:
        open: 0.01
        hold: 0.0075
        min_on: 2
        merge_gap: 1
      offset:
        open: 0.015
        hold: 0.01
        min_off: 2
        merge_gap: 1
    temporal_decoder:
      shared:
        low_ratio: 0.6
        min_on: 2
        min_off: 2
        gap_merge: 1
        median: 3
    aggregation:
      mode: k_of_p
      k:
        onset: 1
        offset: 1
      top_k: 3
      tau_sum: 0.0
  best_selection:
    mode: calibrated_event
    trigger: on_proxy_improvement
    n: 1
    write_back: false
    frames: 96
    max_clips: 40
    split: val
    sweep:
      delta: 0.05
      low_guard: 0.1
    min_prob: 0.02
    max_prob: 0.98
  per_tile:
    enabled: true
    heads:
      - pitch
      - onset
      - offset
    mask_cushion_keys: null
    debug:
      enabled: true
      interval: 200

optim:
  grad_clip: 1.0
  head_lr_multiplier: 10.0
  offset_weight_decay_multiplier: 4.0

train:
  accumulate_steps: 12
  freeze_backbone_epochs: 3

decoder:
  global_fusion:
    enabled: false
    mode: masked_mean
    cushion_keys: 2
    apply_to:
      - onset
      - offset
      - pitch
    weighting: uniform
    consistency_check:
      enabled: false
      batches: 2
  post:
    snap:
      enabled: false
    dp:
      enabled: false
    key_prior:
      enabled: true
      ref_head: onset
      apply_to:
        - onset
        - offset
      window_sec: 3.0
      beta: 4.0
      rho_uniform: 0.8
      prior_strength: 0.5
      epsilon: 1.0e-08
      fps: null
      midi_low: 21
      midi_high: 108

logging:
  log_dir: logs
  checkpoint_dir: checkpoints
  tensorboard: true
  postproc_debug: true

autopilot:
#   best_selection:
#     owner: autopilot
#   fast_strategy: none
#   onset_optimizer:
#     open_grid:
#       - 0.01
#       - 0.015
#       - 0.02
#       - 0.03
#     min_on_grid:
#       - 2
#       - 3
#     hold_mode: fixed_ratio
#     hold_delta: 0.06
#     hold_min: 0.003
#     hold_ratio: 0.75
#     merge_gap: 1
#     thr_anchor: 0.2
#     thr_add_delta: 0.01
#     thr_add_steps: 5
#     thr_mul_ratio: 1.1
#     thr_mul_orders: 1
#     thr_min_prob: 0.005
#     thr_max_prob: 0.98
#     thr_low_guard: 0.01
#     thr_high_guard: 0.6
#     thr_min_points: 5
#     thr_max_points: 11
#   offset_optimizer:
#     thr_anchor: 0.3
#     thr_add_delta: 0.01
#     thr_add_steps: 5
#     thr_mul_ratio: 1.1
#     thr_mul_orders: 1
#     thr_min_prob: 0.02
#     thr_max_prob: 0.98
#     thr_low_guard: 0.02
#     thr_high_guard: 0.95
#     thr_min_points: 5
#     thr_max_points: 11

inference:
  output_dir: inference_results
  predict_on_train: false