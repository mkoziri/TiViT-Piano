# File Index

Generated by `scripts/dev/gen_file_index.py`.

### src/data/__init__.py
**Purpose:** N/A

### src/data/collate.py
**Purpose:** N/A

### src/data/omaps_dataset.py
**Purpose:** N/A

**Key Functions/Classes**
- `_expand_root()` — Picks dataset root in this priority:
- `_read_manifest()` — Read manifest file listing filename stems; '#' comments allowed.
- `_load_clip_decord()` — Returns: T, C, H, W in [0,1], float32
- `_load_clip_cv2()` — Returns: T, C, H, W in [0,1], float32
- `_tile_vertical()` — Split width into vertical tiles: T,C,H,W -> T,tiles,C,H,Wt
- `_labels_from_txt()` — Parse a .txt sidecar file with lines: onset_sec  offset_sec  pitch
- `_read_txt_events()` — Returns a torch.FloatTensor of shape (N, 3) with columns:
- `_load_clip_with_random_start()` — Load a clip using a randomized start (training=True) or start=0 (else).
- `_build_frame_targets()` — Build per-frame targets aligned to sampled frames.
- class `OMAPSDataset` — Visual-only OMAPS loader.

### src/data/omaps_dataset_nw.py
**Purpose:** N/A

**Key Functions/Classes**
- class `OMAPSDataset` — OMAPS-style piano videos (.mp4) + paired .txt labels:

### src/models/__init__.py
**Purpose:** N/A

### src/models/factory.py
**Purpose:** N/A

### src/models/tivit_piano.py
**Purpose:** N/A

**Key Functions/Classes**
- class `TubeletEmbed` — subclass of `torch.nn.Module`; 3D patchify: Conv3d with kernel=(t,p,p), stride=(t,p,p)
- class `TransformerBlock` — subclass of `torch.nn.Module`; Standard encoder block.
- class `FactorizedSpaceTimeEncoder` — subclass of `torch.nn.Module`; Factorized attention like ViViT Model-3/2 with an extra global stage:
- class `TiViTPiano` — subclass of `torch.nn.Module`; Expected input from dataloader:

### src/utils/__init__.py
**Purpose:** N/A

### src/utils/config.py
**Purpose:** N/A

### src/utils/logging.py
**Purpose:** N/A

**Key Functions/Classes**
- `setup_logging()` — Configure and return a root logger.
- `get_logger()` — Return a module-level logger.

### src/utils/pitch.py
**Purpose:** Pitch utility helpers.

**Key Functions/Classes**
- `align_pitch_dim()` — Align ``target`` pitch dimension to match ``pred``.

### src/utils/time_grid.py
**Purpose:** Utility functions for converting between seconds and frame indices on a uniform time grid.

**Key Functions/Classes**
- `sec_to_frame()` — Convert time in seconds to a frame index.
- `frame_to_sec()` — Convert frame index to time in seconds.

### scripts/calibrate.py
**Purpose:** N/A

**Key Functions/Classes**
- `set_yaml()` — Set a nested YAML key in configs/config.yaml (e.g., ('training','reset_head_bias'), False).
- `run_sweep()` — Run scripts/sweep.py with a list of CLI args.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--epochs` | epochs | int | `2` | Epochs per run. |
| `--max_clips` | max_clips | int | `2` | Dataset clips per split for fast sweeps. |
| `--results` | results | str | `calibration_results.txt` | Where to append results. |
| `--tag` | tag | str | `` | Tag added to experiment names. |
| `--skip_bias_toggle` | skip_bias_toggle | store_true | `` | Skip the reset_head_bias OFF/ON comparison. |

### scripts/calibrate_thresholds.py
**Purpose:** N/A

**Key Functions/Classes**
- `_pool_roll_BT()` — Downsample a (B,T,P) pianoroll along time using max pooling.
- `_binary_f1()` — Binary F1 score for tensors in {0,1}.
- `_reliability_curve()` — Compute reliability data and save a diagram.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--ckpt` | ckpt | str | `checkpoints/tivit_best.pt` |  |
| `--split` | split | str | `` | Dataset split to evaluate Choices: train, val, test. |
| `--max-clips` | max_clips | int | `` |  |
| `--frames` | frames | int | `` |  |

### scripts/check_model.py
**Purpose:** N/A

### scripts/check_omaps_integrity.py
**Purpose:** N/A

**Key Functions/Classes**
- `ffprobe_info()` — Return dict with r_frame_rate,width,height,audio_sr or {} if ffprobe missing.
- `scan_split()` — Return list of piece dicts for a split directory that contains *.mp4+*.txt pairs.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--root` | root | Path | `` | Dataset root that contains 'train' and 'test' subfolders |
| `--probe-media` | probe_media | store_true | `` | Use ffprobe to log FPS/resolution/audio rate if available |
| `--meta-dir` | meta_dir | Path | `` |  |
| `--report-dir` | report_dir | Path | `` |  |

### scripts/clean_tivit.py
**Purpose:** N/A

**Key Functions/Classes**
- `load_cfg_paths()` — Read configs/config.yaml to discover logging dirs if present.
- `assert_project_layout()` — Sanity check: must look like your TiViT repo root.
- `list_targets()` — Return the exact paths to delete based on the known structure.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--project-root` | project_root | Path | `` | Path to TiViT repo root. |
| `--dry-run` | dry_run | store_true | `` | Preview actions only. |
| `--yes, -y` | yes | store_true | `` | No prompt. |
| `--preset` | preset | str | `pre-run` | 'pre-run' removes logs, checkpoints, caches, tmp and __pycache__ (leave code & configs intact). Choices: pre-run, logs, checkpoints, caches, tmp, custom. |
| `--keep-best` | keep_best | store_true | `` | When removing checkpoints, keep files with 'best' in their name. |
| `--delete-logs` | delete_logs | store_true | `` |  |
| `--delete-checkpoints` | delete_checkpoints | store_true | `` |  |
| `--delete-caches` | delete_caches | store_true | `` |  |
| `--delete-tmp` | delete_tmp | store_true | `` |  |
| `--delete-pycache` | delete_pycache | store_true | `` |  |
| `--ignore-config-paths` | ignore_config_paths | store_true | `` | Do not read configs/config.yaml; assume logs/ and checkpoints/. |

### scripts/dev/gen_file_index.py
**Purpose:** Generate docs/FILE_INDEX.md with per-file summaries.

**Key Functions/Classes**
- `_find_root()` — Walk up from *start* until a repository marker is found.
- `parse_cli()` — Extract argparse ``add_argument`` calls from a module.
- `list_defs()` — List top-level functions and classes with docstring summaries.

### scripts/dev/gen_repo_tree.py
**Purpose:** Generate docs/REPO_TREE.md showing repository structure.

**Key Functions/Classes**
- `load_gitignore()` — Load additional ignore patterns from .gitignore.

### scripts/diagnose_onset_offsets.py
**Purpose:** N/A

**Key Functions/Classes**
- `pick_input_tensor()` — Try common keys your collate might use.
- `find_logits()` — Return (onset_logits, offset_logits) from model output dict.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--config` | config | str | `configs/config.yaml` |  |
| `--ckpt` | ckpt | str | `checkpoints/tivit_best.pt` |  |
| `--split` | split | str | `train` | Choices: train, val, test. |
| `--batches` | batches | int | `5` |  |
| `--device` | device | str | `auto` | Choices: auto, cpu, cuda. |

### scripts/dump_labels.py
**Purpose:** N/A

**Key Functions/Classes**
- `pick_train_loader()` — Accepts any of:

### scripts/eval_thresholds.py
**Purpose:** N/A

**Key Functions/Classes**
- `_parse_list()` — Extract ``--<name>`` from ``argv`` allowing comma/space separation.
- `_binary_f1()` — Binary F1 score for tensors in {0,1}.
- `_event_f1()` — Event-level F1 score with time tolerance.
- `_pool_roll_BT()` — Downsample a (B,T,P) pianoroll along time using max pooling.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--ckpt` | ckpt | str | `checkpoints/tivit_best.pt` |  |
| `--thresholds` | thresholds | str | `` | Logit threshold values |
| `--prob_thresholds` | prob_thresholds | str | `` | Probability threshold values |
| `--calibration` | calibration | str | `` | JSON file with calibrated thresholds |
| `--head` | head | str | `` | Sweep thresholds for only one head Choices: onset, offset. |
| `--fixed_offset_prob` | fixed_offset_prob | float | `` |  |
| `--fixed_offset_logit` | fixed_offset_logit | float | `` |  |
| `--fixed_onset_prob` | fixed_onset_prob | float | `` |  |
| `--fixed_onset_logit` | fixed_onset_logit | float | `` |  |
| `--temperature` | temperature | float | `1.0` | Scale logits by this temperature before sigmoid; >1 softens predictions |
| `--bias` | bias | float | `0.0` | Additive bias applied to logits before sigmoid |
| `--split` | split | str | `` | Dataset split to evaluate Choices: train, val, test. |
| `--max-clips` | max_clips | int | `` |  |
| `--frames` | frames | int | `` |  |
| `--debug` | debug | store_true | `` | Log extra diagnostics for first batch |

### scripts/inspect_ckpt.py
**Purpose:** N/A

### scripts/lag_sweep.py
**Purpose:** Lag sweep between model predictions and ground truth events.  This script loads a single clip, runs the trained model on a chosen head

**Key Functions/Classes**
- `_align()` — Align two 1-D tensors according to shift ``delta``.
- `_safe_corr()` — Normalized cross-correlation that is safe for zero-variance inputs.
- `_find_clip()` — Return the path to the first clip whose name contains ``key``.
- `_load_window()` — Load a window ``[start_sec, start_sec+seconds)`` from ``path``.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--split` | split | str | `` | Dataset split Choices: train, val, test. |
| `--clip` | clip | str | `` | Clip id or substring |
| `--seconds` | seconds | float | `` | Window length in seconds |
| `--start_sec` | start_sec | float | `0.0` | Start time of window in seconds |
| `--ckpt` | ckpt | str | `` | Path to model checkpoint |
| `--head` | head | str | `` | Model head to use Choices: onset, offset. |
| `--use_logits` | use_logits | str | `True` | Operate on logits (default) or probabilities |
| `--prob_threshold` | prob_threshold | float | `0.2` | Threshold when using probabilities |
| `--max_shift` | max_shift | int | `5` | Maximum +/- frame shift for sweep |

### scripts/make_calib_split.py
**Purpose:** N/A

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--meta-train` | meta_train | Path | `` | Path to Step 0 output for the TRAIN split |
| `--calib-frac` | calib_frac | float | `0.1` | Fraction of TRAIN to sample (per speed bin) |
| `--bins` | bins | int | `5` | Number of quantile bins for notes/sec |
| `--seed` | seed | int | `42` |  |
| `--out-dir` | out_dir | Path | `` |  |
| `--symlink-out` | symlink_out | Path | `` | Optional directory to symlink the calib subset (videos+labels) |

### scripts/parse_sweep.py
**Purpose:** N/A

**Key Functions/Classes**
- `parse_val_line()` — Parse 'key=value' tokens separated by spaces into numbers when possible.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--results` | results | str | `sweep_results.txt` | Path to results file. |
| `--out_csv` | out_csv | str | `sweep_summary.csv` | Output CSV path. |
| `--out_md` | out_md | str | `sweep_summary.md` | Output Markdown table path. |
| `--sort_by` | sort_by | str | `onset_f1` | Metric to sort by (desc). Use '-metric' for ascending, e.g., '-total'. |
| `--filter_retcode` | filter_retcode | int | `0` | Keep only rows with this retcode. Set to -1 to keep all. |

### scripts/probe_timegrid.py
**Purpose:** Quick diagnostic of the time grid for a single clip.  For the first clip from the configured dataset (test split), print:

### scripts/sweep.py
**Purpose:** N/A

**Key Functions/Classes**
- `slug()` — Filesystem-safe short slug.
- `short_id()` — Short stable id from param combo.
- `parse_list()` — Parse comma-separated list; empty -> [None].
- `base_from_config_name()` — Strip any previous sweep suffix from a config experiment name.
- `run_train()` — Run training and capture LAST 'Val:' line from stdout.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--repo` | repo | str | `.` | Project root (where configs/, scripts/, src/ live). |
| `--python` | python | str | `` | Python executable. |
| `--base_config` | base_config | str | `configs/config.yaml` | Config path relative to repo. |
| `--results` | results | str | `sweep_results.txt` | Output results file (relative to repo). |
| `--epochs` | epochs | int | `None` | Override training.epochs for quick sweeps. |
| `--base_exp_name` | base_exp_name | str | `` | Optional: override base experiment name (else derive from config). |
| `--gamma` | gamma | str | `` | focal_gamma list, e.g. '1.5,2.0,3.0' |
| `--alpha` | alpha | str | `` | focal_alpha list, e.g. '0.05,0.10' |
| `--threshold` | threshold | str | `` | prob_threshold list, e.g. '0.2,0.3,0.4' |
| `--prior_mean` | prior_mean | str | `` | onoff_prior_mean list, e.g. '0.01,0.02,0.05' |
| `--prior_weight` | prior_weight | str | `` | onoff_prior_weight list, e.g. '0.02,0.05,0.10' |
| `--tolerance` | tolerance | str | `` | frame_targets.tolerance list, e.g. '0.05,0.10' |
| `--dilate` | dilate | str | `` | frame_targets.dilate_active_frames list, e.g. '0,1,2' |
| `--max_clips` | max_clips | str | `` | dataset.max_clips list, e.g. '2,4' |
| `--tag` | tag | str | `` | Optional tag to include in experiment name/logs. |

### scripts/test_forward.py
**Purpose:** N/A

### scripts/test_labels.py
**Purpose:** N/A

### scripts/test_loader.py
**Purpose:** N/A

### scripts/test_synthetic_forward.py
**Purpose:** N/A

### scripts/train.py
**Purpose:** N/A

**Key Functions/Classes**
- `_pick_loader()` — Accepts:
- `_time_pool_out_to_clip()` — If logits are time-distributed (B,T,...) but we're about to use clip losses,
- class `FocalBCE` — subclass of `torch.nn.Module`; Binary focal loss on logits. Targets in {0,1}, logits are raw (pre-sigmoid).
- `_set_onoff_head_bias()` — Calibrate onset/offset last-layer biases to a small prior P≈1% (negative logits).
- `compute_loss_frame()` — Frame-level objective with the repo's time alignment:

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--config` | config | str | `configs/config.yaml` |  |
| `--train-split` | train_split | str | `` | Dataset split for training Choices: train, val, test. |
| `--val-split` | val_split | str | `` | Validation split Choices: train, val, test. |
| `--max-clips` | max_clips | int | `` |  |
| `--frames` | frames | int | `` |  |
| `--debug` | debug | store_true | `` | Enable verbose logging |
| `--smoke` | smoke | store_true | `` | Run a quick synthetic pass |

### scripts/train_w0.py
**Purpose:** N/A

**Key Functions/Classes**
- `_time_pool_out_to_clip()` — If logits are time-distributed (B,T,...) but we're about to use clip losses,
- class `FocalBCE` — subclass of `torch.nn.Module`; Binary focal loss on logits. Targets in {0,1}, logits are raw (pre-sigmoid).
- `_set_onoff_head_bias()` — Calibrate onset/offset last-layer biases to a small prior P≈1% (negative logits).
- `compute_loss_frame()` — Frame-level objective with time alignment + robust class imbalance handling.

### scripts/train_w1.py
**Purpose:** N/A

**Key Functions/Classes**
- `_pick_loader()` — Accepts:
- `_time_pool_out_to_clip()` — If logits are time-distributed (B,T,...) but we're about to use clip losses,
- class `FocalBCE` — subclass of `torch.nn.Module`; Binary focal loss on logits. Targets in {0,1}, logits are raw (pre-sigmoid).
- `_set_onoff_head_bias()` — Calibrate onset/offset last-layer biases to a small prior P≈1% (negative logits).
- `compute_loss_frame()` — Frame-level objective with time alignment + robust class imbalance handling.

### __init__.py
**Purpose:** Top-level package for TiViT utilities.

### configs/config.yaml
Top-level keys: experiment, dataset, model, training, optim, train, logging, inference

### configs/config_base.yaml
Top-level keys: experiment, dataset, model, training, logging, inference

### configs/config_full.yaml
Top-level keys: experiment, dataset, model, training, logging, inference

### configs/config_old.yaml
Top-level keys: experiment, dataset, model, training, logging, inference
