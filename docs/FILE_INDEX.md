# File Index

Generated by `scripts/dev/gen_file_index.py`.

### src/data/__init__.py
**Purpose:** Purpose:     Provide convenient imports for dataset factories used throughout the     project.  ``make_dataloader`` now routes to either the OMAPS or PianoYT

### src/data/collate.py
**Purpose:** Purpose:     Provide custom collation utilities for batching frame-wise piano datasets     with dense or sparse target encodings.

### src/data/loader.py
**Purpose:** Purpose:     Route dataset construction to the appropriate backend (OMAPS or PianoYT)     while keeping a single public ``make_dataloader`` entry point.  This allows

### src/data/omaps_dataset.py
**Purpose:** Purpose:     Implement the OMAPS dataset loader used by TiViT-Piano, including video     decoding, label parsing, and frame-level target generation.

**Key Functions/Classes**
- `_expand_root()` — Picks dataset root in this priority:
- `_read_manifest()` — Read manifest file listing filename stems; '#' comments allowed.
- `_load_clip_decord()` — Returns: T, C, H, W in [0,1], float32
- `_load_clip_cv2()` — Returns: T, C, H, W in [0,1], float32
- `_labels_from_txt()` — Parse a .txt sidecar file with lines: onset_sec  offset_sec  pitch
- `_find_annotation_for_video()` — Locate a sidecar annotation file for ``video_path``.
- `_read_txt_events()` — Returns a torch.FloatTensor of shape (N, 3) with columns:
- `_load_clip_with_random_start()` — Load a clip using a randomized start (training=True) or start=0 (else).
- `_extract_crop_values()` — Normalize metadata describing a crop box into ``(min_y, max_y, min_x, max_x)``.
- `apply_registration_crop()` — Crop ``frames`` (T,C,H,W) according to registration metadata.
- `resize_to_canonical()` — Resize clip ``frames`` (T,C,H,W) to canonical ``(H,W)`` if provided.
- `apply_global_augment()` — Apply clip-consistent global augmentations prior to tiling.
- class `OMAPSDataset` — Visual-only OMAPS loader.

### src/data/pianoyt_dataset.py
**Purpose:** Purpose:     Implement the PianoYT dataset loader with the same runtime surface as the     existing :mod:`omaps_dataset` module.  The loader mirrors the clip sampling

**Key Functions/Classes**
- class `SampleRecord`
- class `WindowEntry`
- class `SampleBuildResult`
- `_safe_expanduser()` — Expand ``~`` safely even when ``Path.expanduser`` cannot.
- `_expand_root()` — Resolve the PianoYT root directory with environment fallbacks.
- `_resolve_media_paths()` — Find the video and MIDI paths for ``video_id`` within ``split``.
- `_read_midi_events()` — Return ``(N,3)`` tensor [onset_sec, offset_sec, pitch] parsed from MIDI.
- class `PianoYTDataset` — Dataset that mirrors :class:`OMAPSDataset` but reads PianoYT assets.
- `build_onset_sampler_metadata()` — Expose onset/background/start-frame metadata for the opt-in sampler.

### `src/data/pianovam_dataset.py`
**Purpose:** Implement the PianoVAM dataset loader with the same runtime surface as the existing `OMAPSDataset` and `PianoYTDataset` classes. Wraps the PianoVAM_v1.0 corpus (metadata JSON + per-clip assets under `Audio/`, `MIDI/`, `Video/`, `TSV/`, and `Handskeleton/`).

- `_expand_root()`: Resolve the PianoVAM root directory with environment fallbacks (explicit `root_dir`, `$TIVIT_DATA_DIR/PianoVAM_v1.0`, `$DATASETS_HOME/PianoVAM_v1.0`, `~/datasets/PianoVAM_v1.0`).
- `PianoVAMDataset`: Dataset class that mirrors `PianoYTDataset` but reads PianoVAM assets.


### src/data/sampler_utils.py
**Purpose:** Helper utilities for opt-in onset-balanced sampling, including metadata discovery and weight construction for `WeightedRandomSampler`.

**Key Functions/Classes**
- class `SamplerGroups` — Container describing onset/near-miss/background index partitions.
- `build_onset_balanced_sampler()` — Return a seeded sampler when `dataset.sampler.mode` is `onset_balanced`, falling back to uniform shuffling otherwise.

### src/models/__init__.py
**Purpose:** Purpose:     Provide canonical entry points for constructing TiViT-Piano models. 

### src/models/factory.py
**Purpose:** Purpose:     Provide a thin factory that instantiates :class:`TiViTPiano` from nested     configuration dictionaries used across training and evaluation scripts.

### src/models/tivit_piano.py
**Purpose:** Purpose:     Define the TiViT-Piano neural network architecture including tubelet     embedding, factorized space-time attention, and multi-task prediction

**Key Functions/Classes**
- class `TubeletEmbed` — subclass of `torch.nn.Module`; 3D patchify: Conv3d with kernel=(t,p,p), stride=(t,p,p)
- class `TransformerBlock` — subclass of `torch.nn.Module`; Standard encoder block.
- class `FactorizedSpaceTimeEncoder` — subclass of `torch.nn.Module`; Factorized attention like ViViT Model-3/2 with an extra global stage:
- class `MultiLayerHead` — subclass of `torch.nn.Module`; Light-weight MLP head with normalization, hidden layers, and dropout.
- class `TiViTPiano` — subclass of `torch.nn.Module`; Expected input from dataloader:

### src/utils/__init__.py
**Purpose:** Purpose:     Surface commonly used utility helpers for configuration loading, logging,     pitch alignment, and time-grid conversions.

### src/utils/av_sync.py
**Purpose:** Purpose:     Estimate and cache audio/video alignment offsets used across TiViT     datasets.  Provides guarded correlation search plus disk-backed lag cache.

**Key Functions/Classes**
- class `AVLagResult` — Container for audio/visual lag estimation outputs.
- class `AVLagCache` — Cache of per-video lag estimates persisted to JSON.
- `round_lag_ms_for_cache()` — Round ``lag_ms`` to the nearest frame duration for cache keys.

### src/utils/config.py
**Purpose:** Purpose:     Load YAML configuration files with path expansion for TiViT-Piano scripts. 

### src/utils/frame_target_cache.py
**Purpose:** Purpose:     Persist frame-target tensors for specific video/lag configurations so     datasets only rebuild targets when inputs change.

**Key Functions/Classes**
- class `FrameTargetMeta` — Metadata stored alongside cached frame targets.
- `_round_lag_ms_legacy()` — Replicate the historic ms-based rounding used for compatibility.
- `make_target_cache_key()` — Serialise cache key inputs and return a SHA1 hash plus metadata.
- class `FrameTargetCache` — Disk-backed cache storing frame target tensors per configuration.

### src/utils/frame_targets.py
**Purpose:** Purpose:     Build and cache frame-level piano targets aligned to sampled video clips,     including configuration helpers shared by PianoYT and OMAPS datasets.

**Key Functions/Classes**
- `_normalise_clef_thresholds()` — Coerce the clef threshold configuration into a 2-tuple of ints.
- class `FrameTargetSpec` — Immutable configuration for frame-level target construction.
- class `FrameTargetResult` — Payload returned when preparing frame targets for a clip.
- `resolve_frame_target_spec()` — Normalise configuration mapping into a :class:`FrameTargetSpec`.
- `resolve_lag_ms()` — Derive the final lag (ms) and descriptive source string.
- `build_dense_frame_targets()` — Build per-frame dense targets aligned to sampled frames.
- `prepare_frame_targets()` — Load or construct frame targets for a clip using a shared pipeline.

### src/utils/identifiers.py
**Purpose:** Purpose:     Normalise dataset-specific identifiers so caches, metadata, and file paths     share a consistent `video_###` naming scheme.

**Key Functions/Classes**
- `canonical_video_id()` — Return a canonical ``video_XXX`` style identifier for a sample.
- `id_aliases()` — Return canonical plus known legacy ID aliases for ``canon_id``.
- `log_legacy_id_hit()` — Emit a single compat log the first time a legacy ID mapping is used.

### src/utils/logging.py
**Purpose:** Purpose:     Provide consistent logging helpers for TiViT-Piano scripts and libraries. 

**Key Functions/Classes**
- `setup_logging()` — Configure logging using the legacy debug toggle.
- `get_logger()` — Return a module-level logger.

### src/utils/logging_utils.py
**Purpose:** Logging helpers for configuring TiViT verbosity levels.  This module centralises the root logging configuration so CLI entry points can

**Key Functions/Classes**
- class `_QuietInfoFilter` — Allow INFO logs through in quiet mode only when explicitly flagged.
- `_coerce_level_name()` — Normalize a verbosity string using environment fallback.
- `configure_verbosity()` — Configure root logging for the requested verbosity.

### src/utils/pitch.py
**Purpose:** Purpose:     Provide functions for aligning pitch dimensions between model outputs and     dataset targets while logging helpful diagnostics.

**Key Functions/Classes**
- `align_pitch_dim()` — Align ``target`` pitch dimension to match ``pred``.

### src/utils/registration_refinement.py
**Purpose:** Registration refinement utilities for per-video keyboard rectification.  This module estimates a refined homography that maps cropped piano keyboard

**Key Functions/Classes**
- `_find_peak()` — Return the index of the strongest response around ``center``.
- `_snap_edges_ransac()` — Project detected edges onto a regular grid while limiting local drift.
- `_compute_keyboard_edges()` — Estimate white-key edge locations across the keyboard span.
- `_compute_black_key_gaps()` — Detect black-key gap anchors using intensity minima.
- `_homography_to_vector()` — Flatten a homography into an 8D vector with bottom-right entry normalised.
- `_solve_regularized_homography()` — Solve a least-squares homography with Tikhonov regularisation.
- `_invert_homography()` — Return the inverse of a 3x3 homography as float32 array.
- class `RegistrationResult`
- class `RegistrationRefiner` — Refines per-video keyboard registration using homography estimation.

### src/utils/tiling.py
**Purpose:** Utility functions for token-aligned tiling used by pipeline v2.

**Key Functions/Classes**
- `auto_split_tokens()` — Split ``total_tokens`` into ``tiles`` groups differing by at most one.
- `tile_vertical_token_aligned()` — Tile ``x`` so that widths align with the ViT patch grid.

### src/utils/time_grid.py
**Purpose:** Purpose:     Convert between seconds and frame indices on a uniform time grid using     tensor-friendly helper functions.

**Key Functions/Classes**
- `sec_to_frame()` — Convert time in seconds to a frame index.
- `frame_to_sec()` — Convert frame index to time in seconds.

### scripts/calib/calibrate.py
**Purpose:** Purpose:     Coordinate multi-phase calibration sweeps by editing ``configs/config.yaml``     and invoking :mod:`scripts.sweep` with curated parameter grids.

**Key Functions/Classes**
- `set_yaml()` — Set a nested YAML key in configs/config.yaml (e.g., ('training','reset_head_bias'), False).
- `run_sweep()` — Run scripts/sweep.py with a list of CLI args.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--epochs` | epochs | int | `2` | Epochs per run. |
| `--max_clips` | max_clips | int | `2` | Dataset clips per split for fast sweeps. |
| `--results` | results | str | `calibration_results.txt` | Where to append results. |
| `--tag` | tag | str | `` | Tag added to experiment names. |
| `--skip_bias_toggle` | skip_bias_toggle | store_true | `` | Skip the reset_head_bias OFF/ON comparison. |

### scripts/calib/calibrate_thresholds.py
**Purpose:** Calibrate onset/offset thresholds for TiViT-Piano checkpoints.  Purpose:

**Key Functions/Classes**
- `_fit_platt_scaling()` — Fit Platt scaling (temperature + bias) via logistic regression.
- `_pool_roll_BT()` — Downsample a (B,T,P) pianoroll along time using max pooling.
- `_binary_f1()` — Binary F1 score for tensors in {0,1}.
- `_reliability_curve()` — Compute reliability data and save a diagram.
- `_extract_lag_values()` — Flatten lag payloads (ints, floats, tensors, lists) into plain floats.
- `_extract_lag_sources()` — Collect lag source labels from nested payloads.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--ckpt` | ckpt | str | `checkpoints/tivit_best.pt` |  |
| `--split` | split | str | `` | Dataset split to evaluate Choices: train, val, test. |
| `--max-clips` | max_clips | int | `` | Limit number of clips evaluated (default: config) |
| `--frames` | frames | int | `` | Frames per clip during calibration (default: config) |
| `--timeout-mins` | timeout_mins | float | `` | Optional timeout in minutes; stops early while keeping partial stats |
| `--no-avlag` | no_avlag | store_true | `` | Disable audio/video lag estimation when preparing frame targets |
| `--verbose` | verbose | str | `` | Logging verbosity (default: quiet or $TIVIT_VERBOSE) Choices: quiet, info, debug. |
| `--debug` | debug | store_true | `` | Force single-process dataloading like fast eval (num_workers=0, no pinning) |

### scripts/calib/dump_labels.py
**Purpose:** Purpose:     Inspect dataloader outputs for debugging by printing label tensors,     metadata, and summary statistics for a single batch.

**Key Functions/Classes**
- `pick_train_loader()` — Accepts any of:

### scripts/calib/eval_thresholds.py
**Purpose:** Purpose:     Sweep onset/offset thresholds and evaluate frame- and event-level metrics,     optionally dumping logits for further analysis.

**Key Functions/Classes**
- `_prepare_logits_for_dump()` — Flatten a tensor to (T,P) and return a contiguous float64 numpy array.
- `_parse_list()` — Extract ``--<name>`` from ``argv`` allowing comma/space separation.
- `_resolve_threshold_lists()` — Return onset/offset lists, cloning inputs and reusing values when missing.
- `_binary_f1()` — Binary F1 score for tensors in {0,1}.
- `_event_f1()` — Event-level F1 score with time tolerance.
- `_pool_roll_BT()` — Downsample a (B,T,P) pianoroll along time using max pooling.
- `_median_filter_time()` — Apply a 1D median filter along the time axis of a (T,P) pianoroll.
- `decode_hysteresis()` — Decode per-key probabilities with hysteresis and simple duration rules.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--ckpt` | ckpt | str | `checkpoints/tivit_best.pt` |  |
| `--thresholds` | thresholds | str | `` | Logit threshold values |
| `--offset_thresholds` | offset_thresholds | str | `` | Logit threshold values for the offset head (default: reuse onset thresholds) |
| `--prob_thresholds` | prob_thresholds | str | `` | Probability threshold values |
| `--offset_prob_thresholds` | offset_prob_thresholds | str | `` | Probability threshold values for the offset head (default: reuse onset thresholds) |
| `--calibration` | calibration | str | `` | JSON file with calibrated thresholds |
| `--head` | head | str | `` | Sweep thresholds for only one head Choices: onset, offset. |
| `--fixed_offset_prob` | fixed_offset_prob | float | `` |  |
| `--fixed_offset_logit` | fixed_offset_logit | float | `` |  |
| `--fixed_onset_prob` | fixed_onset_prob | float | `` |  |
| `--fixed_onset_logit` | fixed_onset_logit | float | `` |  |
| `--temperature` | temperature | float | `1.0` | Scale logits by this temperature before sigmoid; >1 softens predictions |
| `--bias` | bias | float | `0.0` | Additive bias applied to logits before sigmoid |
| `--split` | split | str | `` | Dataset split to evaluate Choices: train, val, test. |
| `--max-clips` | max_clips | int | `` |  |
| `--frames` | frames | int | `` |  |
| `--only` | only | str | `` | Restrict evaluation to a single canonical video id |
| `--verbose` | verbose | str | `` | Logging verbosity (default: quiet or $TIVIT_VERBOSE) Choices: quiet, info, debug. |
| `--no-avlag` | no_avlag | store_true | `` | Disable audio/video lag estimation for isolation |
| `--dump_logits` | dump_logits | str | `` | Optional path to save per-frame logits as a compressed NPZ |
| `--grid_prob_thresholds` | grid_prob_thresholds | store_true | `` | Evaluate the Cartesian product of onset/offset probability thresholds |
| `--sweep_k_onset` | sweep_k_onset | store_true | `` | When aggregation mode is k_of_p, sweep k_onset over {1,2,3} |
| `--progress` | progress | str | `True` | Enable or disable periodic progress logging |
| `--progress-interval` | progress_interval | float | `5.0` | Minimum number of seconds between progress prints |
| `--log-file` | log_file | str | `` | Optional file path to tee progress logs |
| `--decoder` | decoder | str | `none` | Temporal decoder applied during evaluation (default: none) Choices: none, hysteresis. |
| `--low_ratio` | low_ratio | float | `0.6` | Multiplier to derive the low hysteresis threshold (default: 0.6) |
| `--min_on` | min_on | int | `2` | Drop predicted on-segments shorter than this many frames (default: 2) |
| `--min_off` | min_off | int | `2` | Merge gaps shorter than this many frames between ons (default: 2) |
| `--gap_merge` | gap_merge | int | `1` | Merge on-segments separated by gaps <= this many frames (default: 1) |
| `--median` | median | int | `3` | Odd window size for optional time-axis median smoothing (default: 3) |

### scripts/calib/inspect_ckpt.py
**Purpose:** Purpose:     Inspect checkpoint files to print stored metrics, epoch numbers, and     top-level keys for quick debugging.

### scripts/calib/lag_sweep.py
**Purpose:** Purpose:     Inspect the temporal alignment between model predictions and frame targets     by sweeping positive and negative frame shifts. The script crops a

**Key Functions/Classes**
- `_safe_corr()` — Normalized cross-correlation that is safe for zero-variance inputs.
- class `_IndexableDataset`

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--split` | split | str | `` | Choices: train, val, test. |
| `--clip` | clip | str | `` | Clip id/substring (legacy alias for --clip_key) |
| `--clip_key` | clip_key | str | `` | Clip id/substring to search for |
| `--clip_idx` | clip_idx | int | `` | Explicit dataset index |
| `--seconds` | seconds | float | `` | Window length in seconds |
| `--start_sec` | start_sec | float | `0.0` | Window start in seconds |
| `--ckpt` | ckpt | str | `` | Path to model checkpoint |
| `--head` | head | str | `` | Choices: onset, offset. |
| `--use_logits` | use_logits | str | `True` |  |
| `--prob_threshold` | prob_threshold | float | `0.2` |  |
| `--max_shift` | max_shift | int | `5` |  |

### scripts/calib/make_calib_split.py
**Purpose:** Purpose:     Build a calibration/validation split from any TiViT dataset manifest by     sampling IDs from an input list.  The script replaces the previous

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--root` | root | Path | `` | Dataset root directory |
| `--train-file` | train_file | Path | `` | Path to train ID list |
| `--out-val` | out_val | Path | `` | Output path for validation IDs |
| `--out-train-minus-val` | out_train_minus_val | Path | `` | Output path for remaining IDs |
| `--fraction` | fraction | float | `0.1` | Fraction of train IDs for validation |
| `--seed` | seed | int | `1337` | Sampling seed |
| `--method` | method | str | `hash` | Selection strategy Choices: hash, random. |
| `--respect-excluded` | respect_excluded | Path | `` | Optional list of IDs to exclude |
| `--create-val-dir` | create_val_dir | store_true | `` | Materialize val/ directory |
| `--copy-mode` | copy_mode | str | `symlink` | Copy strategy when creating val dir Choices: symlink, hardlink, none. |

### scripts/calib/parse_sweep.py
**Purpose:** Purpose:     Summarize sweep or calibration experiment logs by parsing TSV-like rows,     sorting metrics, and writing CSV/Markdown reports.

**Key Functions/Classes**
- `parse_val_line()` — Parse 'key=value' tokens separated by spaces into numbers when possible.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--results` | results | str | `sweep_results.txt` | Path to results file. |
| `--out_csv` | out_csv | str | `sweep_summary.csv` | Output CSV path. |
| `--out_md` | out_md | str | `sweep_summary.md` | Output Markdown table path. |
| `--sort_by` | sort_by | str | `onset_f1` | Metric to sort by (desc). Use '-metric' for ascending, e.g., '-total'. |
| `--filter_retcode` | filter_retcode | int | `0` | Keep only rows with this retcode. Set to -1 to keep all. |

### scripts/calib/sweep.py
**Purpose:** Purpose:     Automate hyperparameter sweeps by editing ``configs/config.yaml``, invoking     the training script, and logging results for later analysis.

**Key Functions/Classes**
- `slug()` — Filesystem-safe short slug.
- `short_id()` — Short stable id from param combo.
- `parse_list()` — Parse comma-separated list; empty -> [None].
- `base_from_config_name()` — Strip any previous sweep suffix from a config experiment name.
- `run_train()` — Run training and capture LAST 'Val:' line from stdout.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--repo` | repo | str | `.` | Project root (where configs/, scripts/, src/ live). |
| `--python` | python | str | `` | Python executable. |
| `--base_config` | base_config | str | `configs/config.yaml` | Config path relative to repo. |
| `--results` | results | str | `sweep_results.txt` | Output results file (relative to repo). |
| `--epochs` | epochs | int | `None` | Override training.epochs for quick sweeps. |
| `--base_exp_name` | base_exp_name | str | `` | Optional: override base experiment name (else derive from config). |
| `--gamma` | gamma | str | `` | focal_gamma list, e.g. '1.5,2.0,3.0' |
| `--alpha` | alpha | str | `` | focal_alpha list, e.g. '0.05,0.10' |
| `--threshold` | threshold | str | `` | prob_threshold list, e.g. '0.2,0.3,0.4' |
| `--prior_mean` | prior_mean | str | `` | onoff_prior_mean list, e.g. '0.01,0.02,0.05' |
| `--prior_weight` | prior_weight | str | `` | onoff_prior_weight list, e.g. '0.02,0.05,0.10' |
| `--tolerance` | tolerance | str | `` | frame_targets.tolerance list, e.g. '0.05,0.10' |
| `--dilate` | dilate | str | `` | frame_targets.dilate_active_frames list, e.g. '0,1,2' |
| `--max_clips` | max_clips | str | `` | dataset.max_clips list, e.g. '2,4' |
| `--tag` | tag | str | `` | Optional tag to include in experiment name/logs. |

### scripts/check/analyze_class_balance.py
**Purpose:** Purpose:     Analyze class distributions across pitch, onset, and offset targets to inform     loss weighting and model design decisions. This is crucial for handling

**Key Functions/Classes**
- class `ClassDistribution` — Lightweight container storing aggregated class counts.
- `compute_class_stats()` — Calculate positive/total statistics for a binary target array.
- `_sum_over_batch_time()` — Sum tensor across all dims except the last (pitch dimension).
- `analyze_frame_level_targets()` — Aggregate frame-wise class statistics from the dataloader.
- `analyze_clip_level_targets()` — Aggregate clip-level class statistics from the dataloader.
- `generate_imbalance_report()` — Generate a human-readable summary with imbalance recommendations.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--config` | config | str | `configs/config.yaml` |  |
| `--split` | split | str | `train` |  |
| `--num-batches` | num_batches | int | `50` |  |

### scripts/check/check_model.py
**Purpose:** Purpose:     Quick smoke test that instantiates the TiViT-Piano model and verifies the     output tensor shapes produced by a dummy forward pass.

### scripts/check/check_omaps_integrity.py
**Purpose:** Purpose:     Validate the on-disk OMAPS dataset by checking video/label pairs, reporting     anomalies, and collecting metadata summaries.

**Key Functions/Classes**
- `ffprobe_info()` — Return dict with r_frame_rate,width,height,audio_sr or {} if ffprobe missing.
- `scan_split()` — Return list of piece dicts for a split directory that contains *.mp4+*.txt pairs.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--root` | root | Path | `` | Dataset root that contains 'train' and 'test' subfolders |
| `--probe-media` | probe_media | store_true | `` | Use ffprobe to log FPS/resolution/audio rate if available |
| `--meta-dir` | meta_dir | Path | `` |  |
| `--report-dir` | report_dir | Path | `` |  |

### scripts/check/check_pianoyt_integrity.py
**Purpose:** Purpose:     Validate the on-disk PianoYT dataset by checking video/MIDI pairs, reporting     anomalies, and collecting metadata summaries.

**Key Functions/Classes**
- `read_midi()` — Return [(onset_sec, offset_sec, pitch)] events from ``midi_path``.
- `ffprobe_info()` — Return dict with r_frame_rate,width,height,audio_sr or {} if ffprobe missing.
- `_save_stage_frame()` — Persist ``tensor``'s first frame to ``base/stage/frame0.png`` if possible.
- `verify_pipeline()` — Run a light-weight pipeline verification using the token-aligned pipeline.
- `scan_split()` — Return list of piece dicts for a PianoYT split.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--root` | root | Path | `` | Dataset root that contains 'train', optional 'val', and 'test' subfolders |
| `--probe-media` | probe_media | store_true | `` | Use ffprobe to log FPS/resolution/audio rate if available |
| `--config` | config | Path | `` | Configuration file used for pipeline verification |
| `--verify-pipeline` | verify_pipeline | store_true | `` | Alias retained for compatibility; pipeline verification now runs by default |
| `--n-samples` | n_samples | int | `1` | Number of samples per split for --verify-pipeline |
| `--dump-dir` | dump_dir | Path | `` | If set, dump first-frame visualisations of each pipeline stage |
| `--strict` | strict | store_true | `` | Exit non-zero when --verify-pipeline detects violations |
| `--meta-dir` | meta_dir | Path | `` | Directory to write pianoyt_*.json reports |
| `--report-dir` | report_dir | Path | `` | Directory to write pianoyt_*.tsv and anomaly listings |

### scripts/check/diagnose_onset_offsets.py
**Purpose:** Purpose:     Analyze onset and offset head behavior across a few batches by logging     probability statistics, exporting CSV/plots, and optionally loading

**Key Functions/Classes**
- `pick_input_tensor()` — Try common keys your collate might use.
- `find_logits()` — Return (onset_logits, offset_logits) from model output dict.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--config` | config | str | `configs/config.yaml` |  |
| `--ckpt` | ckpt | str | `checkpoints/tivit_best.pt` |  |
| `--split` | split | str | `train` | Choices: train, val, test. |
| `--batches` | batches | int | `5` |  |
| `--device` | device | str | `auto` | Choices: auto, cpu, cuda. |

### scripts/check/test_conf.py
**Purpose:** Purpose:     Configure ``sys.path`` so pytest discovers the repository packages during     script-level tests.

### scripts/check/test_forward.py
**Purpose:** Purpose:     Validate a full dataloader-to-model pipeline by running a forward pass on a     real batch and printing timing plus output tensor statistics.

### scripts/check/test_key_prior.py
**Purpose:** Purpose:     Provide unit-style tests that exercise the key-aware prior to ensure key     estimation and rescoring behave as expected.

**Key Functions/Classes**
- `_build_c_major_sequence()` — Construct a deterministic C-major logit sequence.
- `test_estimate_key_posteriors_prefers_c_major()` — The key estimator should strongly favor C major for a C-major sequence.
- `test_rescore_logits_boosts_in_key_classes()` — Rescoring should boost in-key pitch classes relative to out-of-key ones.

### scripts/check/test_labels.py
**Purpose:** Purpose:     Inspect raw and aggregated label structures produced by the configured     dataloader for sanity checking during development.

### scripts/check/test_loader.py
**Purpose:** Purpose:     Iterate over the configured dataloader to print batch shapes and sample     paths, ensuring dataset settings are correct.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--config` | config | str | `configs/config.yaml` | Path to the configuration file. |
| `--split` | split | str | `None` | Dataset split to load. Overrides the split from the config if provided. |
| `--max-batches` | max_batches | int | `2` | Number of batches to iterate over before stopping. |

### scripts/check/test_refinement.py
**Purpose:** Purpose:     Exercise the registration refinement pipeline on a small dataset slice and     report both the observed log output and cached homography statistics.

**Key Functions/Classes**
- `run_dataset_probe()` — Iterate limited clips to trigger cache updates.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--config` | config | str | `configs/config.yaml` | Path to the experiment configuration YAML. |
| `--split` | split | str | `None` | Dataset split to probe (defaults to dataset.split_val or 'val'). |
| `--clips` | clips | int | `2` | Number of clips to process before stopping. |
| `--frames` | frames | int | `None` | Override frames per clip for the probe run. |
| `--batch-size` | batch_size | int | `1` | Override batch size for the temporary dataloader. |
| `--inspect` | inspect | int | `5` | Number of cached homographies to summarise. |
| `--cache` | cache | str | `` | Path to the registration refinement cache. |
| `--log-level` | log_level | str | `INFO` | Logging level (DEBUG, INFO, WARNING, ...). |

### scripts/check/test_synthetic_forward.py
**Purpose:** Purpose:     Run a synthetic forward pass on TiViT-Piano using random inputs to verify     that the model produces outputs with expected shapes outside the training

### scripts/clean_tivit.py
**Purpose:** Purpose:     Remove derived artifacts such as checkpoints, logs, caches, and ``__pycache__``     directories while protecting source code and dataset assets.

**Key Functions/Classes**
- `load_cfg_paths()` — Read configs/config.yaml to discover logging dirs if present.
- `assert_project_layout()` — Sanity check: must look like your TiViT repo root.
- `list_targets()` — Return the exact paths to delete based on the known structure.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--project-root` | project_root | Path | `` | Path to TiViT repo root. |
| `--dry-run` | dry_run | store_true | `` | Preview actions only. |
| `--yes, -y` | yes | store_true | `` | No prompt. |
| `--preset` | preset | str | `pre-run` | 'pre-run' removes logs, checkpoints, caches, tmp and __pycache__ (leave code & configs intact). Choices: pre-run, logs, checkpoints, caches, tmp, custom. |
| `--keep-best` | keep_best | store_true | `` | When removing checkpoints, keep files with 'best' in their name. |
| `--delete-logs` | delete_logs | store_true | `` |  |
| `--delete-checkpoints` | delete_checkpoints | store_true | `` |  |
| `--delete-caches` | delete_caches | store_true | `` |  |
| `--delete-tmp` | delete_tmp | store_true | `` |  |
| `--delete-pycache` | delete_pycache | store_true | `` |  |
| `--ignore-config-paths` | ignore_config_paths | store_true | `` | Do not read configs/config.yaml; assume logs/ and checkpoints/. |

### scripts/dev/gen_file_index.py
**Purpose:** Purpose:     Generate ``docs/FILE_INDEX.md`` summarizing module purposes, top-level     definitions, and CLI arguments across the repository.

**Key Functions/Classes**
- `_find_root()` — Walk up from *start* until a repository marker is found.
- `parse_cli()` — Extract argparse ``add_argument`` calls from a module.
- `list_defs()` — List top-level functions and classes with docstring summaries.

### scripts/dev/gen_repo_tree.py
**Purpose:** Purpose:     Produce a Markdown tree view of the repository while respecting     ``.gitignore`` and project-specific ignore patterns.

**Key Functions/Classes**
- `load_gitignore()` — Load additional ignore patterns from .gitignore.

### scripts/probe_timegrid.py
**Purpose:** Purpose:     Diagnose the dataset time grid by examining the relationship between frame     indices, seconds, and raw label timestamps for a single clip.

### scripts/theory_decode.py
**Purpose:** Purpose:     Apply a music-theory-informed key prior to logits stored in NPZ archives and     persist the adjusted predictions together with updated metadata.

**Key Functions/Classes**
- `parse_apply_to()` — Parse a comma-separated list of heads to adjust.
- `load_npz_logits()` — Load logits and metadata from an NPZ file.
- `validate_logits_shapes()` — Ensure all available logits share the same (T, P) shape.
- `select_reference_head()` — Determine which head to use for estimating key posteriors.
- `build_key_prior_config()` — Create a :class:`KeyPriorConfig` from CLI arguments and metadata.
- `save_npz()` — Write logits arrays and metadata to an NPZ file.
- `maybe_save_key_track()` — Optionally write a CSV summary of the key posterior.
- `maybe_plot_key_posteriors()` — Display a heatmap of the key posterior when requested.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--in_npz` | in_npz | Path | `` | Input NPZ file path. |
| `--out_npz` | out_npz | Path | `` | Path to write the rescored NPZ. |
| `--apply_to` | apply_to | str | `onset` | Comma-separated list of heads to rescore (subset of onset, offset, pitch). |
| `--window_sec` | window_sec | float | `3.0` |  |
| `--beta` | beta | float | `4.0` |  |
| `--rho_uniform` | rho_uniform | float | `0.8` |  |
| `--lambda_key` | lambda_key | float | `0.5` |  |
| `--fps` | fps | float | `None` | Override frame rate (Hz). |
| `--midi_low` | midi_low | int | `None` | Lowest MIDI pitch index included. |
| `--midi_high` | midi_high | int | `None` | Highest MIDI pitch index included. |
| `--ref_head` | ref_head | str | `None` | Reference head to estimate the key posterior (onset, pitch, or offset). |
| `--save_key_track` | save_key_track | Path | `None` | Optional CSV path to save per-frame key posterior summaries. |
| `--plot` | plot | store_true | `` | Display a matplotlib heatmap of the key posterior over time. |

### scripts/train.py
**Purpose:** Purpose:     Train TiViT-Piano models by loading configuration, preparing dataloaders,     running the optimization loop, and logging metrics/checkpoints.

**Key Functions/Classes**
- `_prediction_stats_from_logits()` — Compute basic statistics on sigmoid probabilities for monitoring.
- `_log_prediction_stats()` — Log nested onset/offset stat dict to logger/TensorBoard (diagnostic).
- `_pick_loader()` — Accepts:
- `_time_pool_out_to_clip()` — If logits are time-distributed (B,T,...) but we're about to use clip losses,
- class `FocalBCE` — subclass of `torch.nn.Module`; Binary focal loss on logits. Targets in {0,1}, logits are raw (pre-sigmoid).
- `_set_onoff_head_bias()` — Calibrate onset/offset last-layer biases using a Bernoulli prior mean.
- `_dynamic_pos_weighted_bce()` — Compute BCEWithLogits with adaptive pos_weight derived from current batch.
- `compute_loss_frame()` — Frame-level objective with the repo's time alignment:
- class `SafeEvalCollate`

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--config` | config | str | `configs/config.yaml` |  |
| `--train-split` | train_split | str | `` | Dataset split for training Choices: train, val, test. |
| `--val-split` | val_split | str | `` | Validation split Choices: train, val, test. |
| `--max-clips` | max_clips | int | `` |  |
| `--frames` | frames | int | `` |  |
| `--verbose` | verbose | str | `` | Logging verbosity (default: quiet or $TIVIT_VERBOSE) Choices: quiet, info, debug. |
| `--smoke` | smoke | store_true | `` | Run a quick synthetic pass |

### scripts/train_autopilot.py
**Purpose:** Automated training and calibration driver for TiViT-Piano.  Purpose:

**Key Functions/Classes**
- `_blend_and_clip_platt()` — Blend Platt params toward neutral defaults and enforce safe ranges.
- class `ResumeState`

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--mode` | mode | str | `fresh` | Choices: fresh, resume. |
| `--burst_epochs` | burst_epochs | int | `4` |  |
| `--first_calib` | first_calib | str | `thorough` | Choices: thorough, fast. |
| `--first_step` | first_step | str | `train` | Choices: train, calib. |
| `--skip_train_round1` | skip_train_round1 | store_true | `` |  |
| `--fast_first_calib` | fast_first_calib | store_true | `` |  |
| `--target_ev_f1` | target_ev_f1 | float | `0.65` |  |
| `--target_metric` | target_metric | str | `ev_f1_mean` | Choices: ev_f1_mean, onset_ev_f1, offset_ev_f1. |
| `--max_rounds` | max_rounds | int | `12` |  |
| `--patience` | patience | int | `3` |  |
| `--results` | results | Path | `` |  |
| `--ckpt_dir` | ckpt_dir | Path | `` |  |
| `--split_eval` | split_eval | str | `val` |  |
| `--calib_max_clips` | calib_max_clips | int | `` |  |
| `--calib_frames` | calib_frames | int | `` |  |
| `--temperature` | temperature | float | `` |  |
| `--bias` | bias | float | `` |  |
| `--stdout_dir` | stdout_dir | Path | `` |  |
| `--dataset_max_clips` | dataset_max_clips | int | `` |  |
| `--dry_run` | dry_run | store_true | `` |  |
| `--verbose` | verbose | str | `` | Logging verbosity for autopilot and child runs (default: quiet or $TIVIT_VERBOSE) Choices: quiet, info, debug. |
| `--eval_extras` | eval_extras | str | `` | Extra CLI arguments appended to eval_thresholds.py during fast evaluation |

### __init__.py
**Purpose:** Purpose:     Provide the top-level Python package for TiViT-Piano utilities and re-export     commonly used subpackages.

### tivit.py
**Purpose:** TiViT-Piano top-level package shim.  This repository historically stored its subpackages (such as

**Key Functions/Classes**
- `_import_theory()` — Load the underlying :mod:`theory` package and register it.
- `__getattr__()` — Delegate attribute access to :mod:`theory` for convenience.
- `__dir__()` — Expose dynamic attributes to :func:`dir`.

### configs/config.yaml
Top-level keys: experiment, dataset, model, tiling, training, optim, train, logging, inference
