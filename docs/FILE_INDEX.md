# File Index

Generated by `scripts/dev/gen_file_index.py`.

### src/data/__init__.py
**Purpose:** Purpose:     Provide convenient imports for dataset factories used throughout the     project.

### src/data/collate.py
**Purpose:** Purpose:     Provide custom collation utilities for batching frame-wise piano datasets     with dense or sparse target encodings.

### src/data/omaps_dataset.py
**Purpose:** Purpose:     Implement the OMAPS dataset loader used by TiViT-Piano, including video     decoding, label parsing, and frame-level target generation.

**Key Functions/Classes**
- `_expand_root()` — Picks dataset root in this priority:
- `_read_manifest()` — Read manifest file listing filename stems; '#' comments allowed.
- `_load_clip_decord()` — Returns: T, C, H, W in [0,1], float32
- `_load_clip_cv2()` — Returns: T, C, H, W in [0,1], float32
- `_tile_vertical()` — Split width into vertical tiles: T,C,H,W -> T,tiles,C,H,Wt
- `_labels_from_txt()` — Parse a .txt sidecar file with lines: onset_sec  offset_sec  pitch
- `_read_txt_events()` — Returns a torch.FloatTensor of shape (N, 3) with columns:
- `_load_clip_with_random_start()` — Load a clip using a randomized start (training=True) or start=0 (else).
- `_build_frame_targets()` — Build per-frame targets aligned to sampled frames.
- class `OMAPSDataset` — Visual-only OMAPS loader.

### src/models/__init__.py
**Purpose:** Purpose:     Provide canonical entry points for constructing TiViT-Piano models. 

### src/models/factory.py
**Purpose:** Purpose:     Provide a thin factory that instantiates :class:`TiViTPiano` from nested     configuration dictionaries used across training and evaluation scripts.

### src/models/tivit_piano.py
**Purpose:** Purpose:     Define the TiViT-Piano neural network architecture including tubelet     embedding, factorized space-time attention, and multi-task prediction

**Key Functions/Classes**
- class `TubeletEmbed` — subclass of `torch.nn.Module`; 3D patchify: Conv3d with kernel=(t,p,p), stride=(t,p,p)
- class `TransformerBlock` — subclass of `torch.nn.Module`; Standard encoder block.
- class `FactorizedSpaceTimeEncoder` — subclass of `torch.nn.Module`; Factorized attention like ViViT Model-3/2 with an extra global stage:
- class `TiViTPiano` — subclass of `torch.nn.Module`; Expected input from dataloader:

### src/utils/__init__.py
**Purpose:** Purpose:     Surface commonly used utility helpers for configuration loading, logging,     pitch alignment, and time-grid conversions.

### src/utils/config.py
**Purpose:** Purpose:     Load YAML configuration files with path expansion for TiViT-Piano scripts. 

### src/utils/logging.py
**Purpose:** Purpose:     Provide consistent logging helpers for TiViT-Piano scripts and libraries. 

**Key Functions/Classes**
- `setup_logging()` — Configure and return a root logger.
- `get_logger()` — Return a module-level logger.

### src/utils/pitch.py
**Purpose:** Purpose:     Provide functions for aligning pitch dimensions between model outputs and     dataset targets while logging helpful diagnostics.

**Key Functions/Classes**
- `align_pitch_dim()` — Align ``target`` pitch dimension to match ``pred``.

### src/utils/time_grid.py
**Purpose:** Purpose:     Convert between seconds and frame indices on a uniform time grid using     tensor-friendly helper functions.

**Key Functions/Classes**
- `sec_to_frame()` — Convert time in seconds to a frame index.
- `frame_to_sec()` — Convert frame index to time in seconds.

### scripts/calib/calibrate.py
**Purpose:** Purpose:     Coordinate multi-phase calibration sweeps by editing ``configs/config.yaml``     and invoking :mod:`scripts.sweep` with curated parameter grids.

**Key Functions/Classes**
- `set_yaml()` — Set a nested YAML key in configs/config.yaml (e.g., ('training','reset_head_bias'), False).
- `run_sweep()` — Run scripts/sweep.py with a list of CLI args.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--epochs` | epochs | int | `2` | Epochs per run. |
| `--max_clips` | max_clips | int | `2` | Dataset clips per split for fast sweeps. |
| `--results` | results | str | `calibration_results.txt` | Where to append results. |
| `--tag` | tag | str | `` | Tag added to experiment names. |
| `--skip_bias_toggle` | skip_bias_toggle | store_true | `` | Skip the reset_head_bias OFF/ON comparison. |

### scripts/calib/calibrate_thresholds.py
**Purpose:** Purpose:     Evaluate onset and offset predictions to determine calibrated logit or     probability thresholds and produce reliability diagnostics.

**Key Functions/Classes**
- `_pool_roll_BT()` — Downsample a (B,T,P) pianoroll along time using max pooling.
- `_binary_f1()` — Binary F1 score for tensors in {0,1}.
- `_reliability_curve()` — Compute reliability data and save a diagram.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--ckpt` | ckpt | str | `checkpoints/tivit_best.pt` |  |
| `--split` | split | str | `` | Dataset split to evaluate Choices: train, val, test. |
| `--max-clips` | max_clips | int | `` |  |
| `--frames` | frames | int | `` |  |

### scripts/calib/dump_labels.py
**Purpose:** Purpose:     Inspect dataloader outputs for debugging by printing label tensors,     metadata, and summary statistics for a single batch.

**Key Functions/Classes**
- `pick_train_loader()` — Accepts any of:

### scripts/calib/eval_thresholds.py
**Purpose:** Purpose:     Sweep onset/offset thresholds and evaluate frame- and event-level metrics,     optionally dumping logits for further analysis.

**Key Functions/Classes**
- `_prepare_logits_for_dump()` — Flatten a tensor to (T,P) and return a contiguous float64 numpy array.
- `_parse_list()` — Extract ``--<name>`` from ``argv`` allowing comma/space separation.
- `_binary_f1()` — Binary F1 score for tensors in {0,1}.
- `_event_f1()` — Event-level F1 score with time tolerance.
- `_pool_roll_BT()` — Downsample a (B,T,P) pianoroll along time using max pooling.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--ckpt` | ckpt | str | `checkpoints/tivit_best.pt` |  |
| `--thresholds` | thresholds | str | `` | Logit threshold values |
| `--prob_thresholds` | prob_thresholds | str | `` | Probability threshold values |
| `--calibration` | calibration | str | `` | JSON file with calibrated thresholds |
| `--head` | head | str | `` | Sweep thresholds for only one head Choices: onset, offset. |
| `--fixed_offset_prob` | fixed_offset_prob | float | `` |  |
| `--fixed_offset_logit` | fixed_offset_logit | float | `` |  |
| `--fixed_onset_prob` | fixed_onset_prob | float | `` |  |
| `--fixed_onset_logit` | fixed_onset_logit | float | `` |  |
| `--temperature` | temperature | float | `1.0` | Scale logits by this temperature before sigmoid; >1 softens predictions |
| `--bias` | bias | float | `0.0` | Additive bias applied to logits before sigmoid |
| `--split` | split | str | `` | Dataset split to evaluate Choices: train, val, test. |
| `--max-clips` | max_clips | int | `` |  |
| `--frames` | frames | int | `` |  |
| `--debug` | debug | store_true | `` | Log extra diagnostics for first batch |
| `--dump_logits` | dump_logits | str | `` | Optional path to save per-frame logits as a compressed NPZ |

### scripts/calib/inspect_ckpt.py
**Purpose:** Purpose:     Inspect checkpoint files to print stored metrics, epoch numbers, and     top-level keys for quick debugging.

### scripts/calib/lag_sweep.py
**Purpose:** Purpose:     Diagnose temporal alignment between model predictions and ground-truth     onset/offset labels by sweeping integer frame shifts and evaluating

**Key Functions/Classes**
- `_align()` — Align two 1-D tensors according to shift ``delta``.
- `_safe_corr()` — Normalized cross-correlation that is safe for zero-variance inputs.
- `_find_clip()` — Return the path to the first clip whose name contains ``key``.
- `_load_window()` — Load a window ``[start_sec, start_sec+seconds)`` from ``path``.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--split` | split | str | `` | Dataset split Choices: train, val, test. |
| `--clip` | clip | str | `` | Clip id or substring |
| `--seconds` | seconds | float | `` | Window length in seconds |
| `--start_sec` | start_sec | float | `0.0` | Start time of window in seconds |
| `--ckpt` | ckpt | str | `` | Path to model checkpoint |
| `--head` | head | str | `` | Model head to use Choices: onset, offset. |
| `--use_logits` | use_logits | str | `True` | Operate on logits (default) or probabilities |
| `--prob_threshold` | prob_threshold | float | `0.2` | Threshold when using probabilities |
| `--max_shift` | max_shift | int | `5` | Maximum +/- frame shift for sweep |

### scripts/calib/make_calib_split.py
**Purpose:** Purpose:     Create a calibration subset of the OMAPS training split by stratifying on     note density and optionally symlinking the selected assets.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--meta-train` | meta_train | Path | `` | Path to Step 0 output for the TRAIN split |
| `--calib-frac` | calib_frac | float | `0.1` | Fraction of TRAIN to sample (per speed bin) |
| `--bins` | bins | int | `5` | Number of quantile bins for notes/sec |
| `--seed` | seed | int | `42` |  |
| `--out-dir` | out_dir | Path | `` |  |
| `--symlink-out` | symlink_out | Path | `` | Optional directory to symlink the calib subset (videos+labels) |

### scripts/calib/parse_sweep.py
**Purpose:** Purpose:     Summarize sweep or calibration experiment logs by parsing TSV-like rows,     sorting metrics, and writing CSV/Markdown reports.

**Key Functions/Classes**
- `parse_val_line()` — Parse 'key=value' tokens separated by spaces into numbers when possible.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--results` | results | str | `sweep_results.txt` | Path to results file. |
| `--out_csv` | out_csv | str | `sweep_summary.csv` | Output CSV path. |
| `--out_md` | out_md | str | `sweep_summary.md` | Output Markdown table path. |
| `--sort_by` | sort_by | str | `onset_f1` | Metric to sort by (desc). Use '-metric' for ascending, e.g., '-total'. |
| `--filter_retcode` | filter_retcode | int | `0` | Keep only rows with this retcode. Set to -1 to keep all. |

### scripts/calib/sweep.py
**Purpose:** Purpose:     Automate hyperparameter sweeps by editing ``configs/config.yaml``, invoking     the training script, and logging results for later analysis.

**Key Functions/Classes**
- `slug()` — Filesystem-safe short slug.
- `short_id()` — Short stable id from param combo.
- `parse_list()` — Parse comma-separated list; empty -> [None].
- `base_from_config_name()` — Strip any previous sweep suffix from a config experiment name.
- `run_train()` — Run training and capture LAST 'Val:' line from stdout.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--repo` | repo | str | `.` | Project root (where configs/, scripts/, src/ live). |
| `--python` | python | str | `` | Python executable. |
| `--base_config` | base_config | str | `configs/config.yaml` | Config path relative to repo. |
| `--results` | results | str | `sweep_results.txt` | Output results file (relative to repo). |
| `--epochs` | epochs | int | `None` | Override training.epochs for quick sweeps. |
| `--base_exp_name` | base_exp_name | str | `` | Optional: override base experiment name (else derive from config). |
| `--gamma` | gamma | str | `` | focal_gamma list, e.g. '1.5,2.0,3.0' |
| `--alpha` | alpha | str | `` | focal_alpha list, e.g. '0.05,0.10' |
| `--threshold` | threshold | str | `` | prob_threshold list, e.g. '0.2,0.3,0.4' |
| `--prior_mean` | prior_mean | str | `` | onoff_prior_mean list, e.g. '0.01,0.02,0.05' |
| `--prior_weight` | prior_weight | str | `` | onoff_prior_weight list, e.g. '0.02,0.05,0.10' |
| `--tolerance` | tolerance | str | `` | frame_targets.tolerance list, e.g. '0.05,0.10' |
| `--dilate` | dilate | str | `` | frame_targets.dilate_active_frames list, e.g. '0,1,2' |
| `--max_clips` | max_clips | str | `` | dataset.max_clips list, e.g. '2,4' |
| `--tag` | tag | str | `` | Optional tag to include in experiment name/logs. |

### scripts/check/check_model.py
**Purpose:** Purpose:     Quick smoke test that instantiates the TiViT-Piano model and verifies the     output tensor shapes produced by a dummy forward pass.

### scripts/check/check_omaps_integrity.py
**Purpose:** Purpose:     Validate the on-disk OMAPS dataset by checking video/label pairs, reporting     anomalies, and collecting metadata summaries.

**Key Functions/Classes**
- `ffprobe_info()` — Return dict with r_frame_rate,width,height,audio_sr or {} if ffprobe missing.
- `scan_split()` — Return list of piece dicts for a split directory that contains *.mp4+*.txt pairs.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--root` | root | Path | `` | Dataset root that contains 'train' and 'test' subfolders |
| `--probe-media` | probe_media | store_true | `` | Use ffprobe to log FPS/resolution/audio rate if available |
| `--meta-dir` | meta_dir | Path | `` |  |
| `--report-dir` | report_dir | Path | `` |  |

### scripts/check/diagnose_onset_offsets.py
**Purpose:** Purpose:     Analyze onset and offset head behavior across a few batches by logging     probability statistics, exporting CSV/plots, and optionally loading

**Key Functions/Classes**
- `pick_input_tensor()` — Try common keys your collate might use.
- `find_logits()` — Return (onset_logits, offset_logits) from model output dict.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--config` | config | str | `configs/config.yaml` |  |
| `--ckpt` | ckpt | str | `checkpoints/tivit_best.pt` |  |
| `--split` | split | str | `train` | Choices: train, val, test. |
| `--batches` | batches | int | `5` |  |
| `--device` | device | str | `auto` | Choices: auto, cpu, cuda. |

### scripts/check/test_conf.py
**Purpose:** Purpose:     Configure ``sys.path`` so pytest discovers the repository packages during     script-level tests.

### scripts/check/test_forward.py
**Purpose:** Purpose:     Validate a full dataloader-to-model pipeline by running a forward pass on a     real batch and printing timing plus output tensor statistics.

### scripts/check/test_key_prior.py
**Purpose:** Purpose:     Provide unit-style tests that exercise the key-aware prior to ensure key     estimation and rescoring behave as expected.

**Key Functions/Classes**
- `_build_c_major_sequence()` — Construct a deterministic C-major logit sequence.
- `test_estimate_key_posteriors_prefers_c_major()` — The key estimator should strongly favor C major for a C-major sequence.
- `test_rescore_logits_boosts_in_key_classes()` — Rescoring should boost in-key pitch classes relative to out-of-key ones.

### scripts/check/test_labels.py
**Purpose:** Purpose:     Inspect raw and aggregated label structures produced by the configured     dataloader for sanity checking during development.

### scripts/check/test_loader.py
**Purpose:** Purpose:     Iterate over the configured dataloader to print batch shapes and sample     paths, ensuring dataset settings are correct.

### scripts/check/test_synthetic_forward.py
**Purpose:** Purpose:     Run a synthetic forward pass on TiViT-Piano using random inputs to verify     that the model produces outputs with expected shapes outside the training

### scripts/clean_tivit.py
**Purpose:** Purpose:     Remove derived artifacts such as checkpoints, logs, caches, and ``__pycache__``     directories while protecting source code and dataset assets.

**Key Functions/Classes**
- `load_cfg_paths()` — Read configs/config.yaml to discover logging dirs if present.
- `assert_project_layout()` — Sanity check: must look like your TiViT repo root.
- `list_targets()` — Return the exact paths to delete based on the known structure.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--project-root` | project_root | Path | `` | Path to TiViT repo root. |
| `--dry-run` | dry_run | store_true | `` | Preview actions only. |
| `--yes, -y` | yes | store_true | `` | No prompt. |
| `--preset` | preset | str | `pre-run` | 'pre-run' removes logs, checkpoints, caches, tmp and __pycache__ (leave code & configs intact). Choices: pre-run, logs, checkpoints, caches, tmp, custom. |
| `--keep-best` | keep_best | store_true | `` | When removing checkpoints, keep files with 'best' in their name. |
| `--delete-logs` | delete_logs | store_true | `` |  |
| `--delete-checkpoints` | delete_checkpoints | store_true | `` |  |
| `--delete-caches` | delete_caches | store_true | `` |  |
| `--delete-tmp` | delete_tmp | store_true | `` |  |
| `--delete-pycache` | delete_pycache | store_true | `` |  |
| `--ignore-config-paths` | ignore_config_paths | store_true | `` | Do not read configs/config.yaml; assume logs/ and checkpoints/. |

### scripts/dev/gen_file_index.py
**Purpose:** Purpose:     Generate ``docs/FILE_INDEX.md`` summarizing module purposes, top-level     definitions, and CLI arguments across the repository.

**Key Functions/Classes**
- `_find_root()` — Walk up from *start* until a repository marker is found.
- `parse_cli()` — Extract argparse ``add_argument`` calls from a module.
- `list_defs()` — List top-level functions and classes with docstring summaries.

### scripts/dev/gen_repo_tree.py
**Purpose:** Purpose:     Produce a Markdown tree view of the repository while respecting     ``.gitignore`` and project-specific ignore patterns.

**Key Functions/Classes**
- `load_gitignore()` — Load additional ignore patterns from .gitignore.

### scripts/probe_timegrid.py
**Purpose:** Purpose:     Diagnose the dataset time grid by examining the relationship between frame     indices, seconds, and raw label timestamps for a single clip.

### scripts/theory_decode.py
**Purpose:** Purpose:     Apply a music-theory-informed key prior to logits stored in NPZ archives and     persist the adjusted predictions together with updated metadata.

**Key Functions/Classes**
- `parse_apply_to()` — Parse a comma-separated list of heads to adjust.
- `load_npz_logits()` — Load logits and metadata from an NPZ file.
- `validate_logits_shapes()` — Ensure all available logits share the same (T, P) shape.
- `select_reference_head()` — Determine which head to use for estimating key posteriors.
- `build_key_prior_config()` — Create a :class:`KeyPriorConfig` from CLI arguments and metadata.
- `save_npz()` — Write logits arrays and metadata to an NPZ file.
- `maybe_save_key_track()` — Optionally write a CSV summary of the key posterior.
- `maybe_plot_key_posteriors()` — Display a heatmap of the key posterior when requested.

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--in_npz` | in_npz | Path | `` | Input NPZ file path. |
| `--out_npz` | out_npz | Path | `` | Path to write the rescored NPZ. |
| `--apply_to` | apply_to | str | `onset` | Comma-separated list of heads to rescore (subset of onset, offset, pitch). |
| `--window_sec` | window_sec | float | `3.0` |  |
| `--beta` | beta | float | `4.0` |  |
| `--rho_uniform` | rho_uniform | float | `0.8` |  |
| `--lambda_key` | lambda_key | float | `0.5` |  |
| `--fps` | fps | float | `None` | Override frame rate (Hz). |
| `--midi_low` | midi_low | int | `None` | Lowest MIDI pitch index included. |
| `--midi_high` | midi_high | int | `None` | Highest MIDI pitch index included. |
| `--ref_head` | ref_head | str | `None` | Reference head to estimate the key posterior (onset, pitch, or offset). |
| `--save_key_track` | save_key_track | Path | `None` | Optional CSV path to save per-frame key posterior summaries. |
| `--plot` | plot | store_true | `` | Display a matplotlib heatmap of the key posterior over time. |

### scripts/train.py
**Purpose:** Purpose:     Train TiViT-Piano models by loading configuration, preparing dataloaders,     running the optimization loop, and logging metrics/checkpoints.

**Key Functions/Classes**
- `_pick_loader()` — Accepts:
- `_time_pool_out_to_clip()` — If logits are time-distributed (B,T,...) but we're about to use clip losses,
- class `FocalBCE` — subclass of `torch.nn.Module`; Binary focal loss on logits. Targets in {0,1}, logits are raw (pre-sigmoid).
- `_set_onoff_head_bias()` — Calibrate onset/offset last-layer biases to a small prior P≈1% (negative logits).
- `compute_loss_frame()` — Frame-level objective with the repo's time alignment:

**CLI**
| Flag(s) | Dest | Type | Default | Help |
|---|---|---|---|---|
| `--config` | config | str | `configs/config.yaml` |  |
| `--train-split` | train_split | str | `` | Dataset split for training Choices: train, val, test. |
| `--val-split` | val_split | str | `` | Validation split Choices: train, val, test. |
| `--max-clips` | max_clips | int | `` |  |
| `--frames` | frames | int | `` |  |
| `--debug` | debug | store_true | `` | Enable verbose logging |
| `--smoke` | smoke | store_true | `` | Run a quick synthetic pass |

### __init__.py
**Purpose:** Purpose:     Provide the top-level Python package for TiViT-Piano utilities and re-export     commonly used subpackages.

### tivit.py
**Purpose:** TiViT-Piano top-level package shim.  This repository historically stored its subpackages (such as

**Key Functions/Classes**
- `_import_theory()` — Load the underlying :mod:`theory` package and register it.
- `__getattr__()` — Delegate attribute access to :mod:`theory` for convenience.
- `__dir__()` — Expose dynamic attributes to :func:`dir`.

### configs/config.yaml
Top-level keys: experiment, dataset, model, training, optim, train, logging, inference

### configs/config_base.yaml
Top-level keys: experiment, dataset, model, training, logging, inference

### configs/config_full.yaml
Top-level keys: experiment, dataset, model, training, logging, inference

### configs/config_old.yaml
Top-level keys: experiment, dataset, model, training, logging, inference
